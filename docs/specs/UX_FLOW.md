# 🎤 MinKara - UXフロー設計書

## 現状の問題点

1. **役割選択のタイミングが早すぎる**
   - ルーム入室直後に役割を選ぶ → 誰が歌うか決まっていない状態で選択
   - 「シンガー」を複数人が選んでしまう事故が起きやすい

2. **同期ポイントがない**
   - 歌う人が決まった瞬間に即スタート → 他メンバーが準備できていない
   - 「この曲やります」という通知が他メンバーに届かない

3. **途中参加の考慮**
   - 演奏中に入ってきた人はどうする？

---

## 決定済みの基本方針

1. **利用シーン**: オンライン機能は後回し。まずは**オフライン（同じ場所）**での体験を最適化。
2. **同期**: Supabase Realtime + NTP同期で高精度なリズムゲーム体験を目指す。
3. **曲予約**: カラオケ方式（早い者勝ちキュー）。予約者がその曲のシンガーとなる。
4. **役割切り替え**: **いつでも可能**。演奏中でも「バンド」から「休憩（応援）」へ移行可能。
5. **スコア**: 個別スコア（リズム感、応援量）とチーム全体の盛り上がり度の両方を計測。

---

## 理想のユーザーフロー

### 共通UI: デンモク型ナビゲーション
画面下部（またはサイド）に常設メニューを配置し、いつでもモード切替が可能。

```
┌────────────────────────────────────┐
│                                    │
│       [メインコンテンツエリア]      │
│  (歌詞 / リズムゲーム / MV / 待機)  │
│                                    │
├────────────────────────────────────┤
│  🏠     🎤     🎸     📣    📋      │
│ ロビー  シンガー  バンド   応援   予約   │
└────────────────────────────────────┘
```

---

### Phase 1: ロビー（待機室）
```
┌─────────────────────────────────┐
│         ルーム: ABC123          │
│                                 │
│   🎵 現在の曲: なし              │
│   🎵 次の曲: 千本桜 (予約: たろう)│
│                                 │
│   参加者一覧:                   │
│   ● たろう (準備OK)             │
│   ● はなこ (選曲中...)          │
│                                 │
│   [🎤 曲を予約する]              │
└─────────────────────────────────┘
```

---

### Phase 2: 選曲・予約
- 何人でも予約キューに追加可能。
- 予約した人が「シンガー」権限を持つ。
- 曲の開始トリガー:
  1. シンガー以外のメンバーが役割（バンド/応援）を選択
  2. 10秒程度のタイムアウト後、未選択ユーザーは自動的に「応援」モードへ
  3. 全員準備完了またはタイムアウトで自動スタート

---

### Phase 3: 演奏中（自由な役割変更）

#### A. シンガー画面
- 歌詞表示
- 盛り上がりフィードバック受信（「沸いてる！」演出）

#### B. バンド画面
- リズムゲーム（ノーツ表示）
- **休憩機能**: 「一時停止」ボタンまたはタブ切り替えで、いつでもノーツを止めて応援モードへ移行可能。
  - ※放置してミス連発（画面真っ赤）になるストレスを防ぐ。

#### C. 応援画面
- ペンライト、コールボタン
- 観戦モード（MVを見るだけ）もここに含まれる

---

### Phase 4: 結果発表
- **チームスコア**: 「盛り上がり度」の合計
- **個人表彰**:
  - 🎸 ベストプレイヤー (リズム感)
  - 📣 ベストサポーター (応援回数)
  - 🔥 MVP (総合評価)

---

## 技術的要件 (更新)

1. **高精度同期 (NTP)**
   - リズムゲームとしての成立に必須。
   - `roomStore` にNTPオフセット時間を保持し、各クライアントの時刻を補正。

2. **途中参加・モード切替の処理**
   - 演奏中にバンド参加した場合、その時点の小節からノーツを流す。
   - スコアは「参加していた区間」の評価と「全体への貢献」で算出。

3. **予約キュー管理**
   - Supabaseのテーブルで `reservations` を管理。
   - `status: pending | playing | finished`


---

## 途中参加の扱い

| フェーズ | 途中参加者の挙動 |
|---------|-----------------|
| ロビー | 通常参加 |
| 選曲中 | 「待機中」として参加、曲決定後に役割選択 |
| 準備完了待ち | 「準備完了待ち」に入る（自動で応援扱い？） |
| 演奏中 | 応援として参加（途中からリズムゲームは難しい） |
| 結果 | 結果画面を見る |

---

## 状態遷移図

```
[LOBBY] ─(歌いたい！)─> [SELECTING_SONG] ─(曲決定)─> [ROLE_SELECT]
                                                          │
                                                          v
[RESULT] <─(曲終了)─ [PLAYING] <─(全員準備完了)─ [READY_CHECK]
   │
   └──(次の曲)──> [LOBBY]
```

---

## 実装優先度

### Must Have (MVP)
- [ ] ロビー画面（参加者一覧表示）
- [ ] 「歌いたい」ボタンでシンガー確定
- [ ] 曲選択 → 全員に通知
- [ ] 役割選択（シンガー以外）
- [ ] 全員準備完了でスタート

### Nice to Have
- [ ] 準備完了状況のリアルタイム表示
- [ ] 強制スタートオプション
- [ ] MVP投票

### Future
- [ ] 途中参加の完全対応
- [ ] 曲のローテーション（次は誰？）

---

## 議論ポイント

1. **シンガーの決め方**
   - 早い者勝ち？
   - ホストが指名？
   - じゃんけん機能？

2. **準備完了の判定**
   - 全員必須？
   - タイムアウト（30秒）後に自動スタート？
   - ホストが強制スタート可能？

3. **途中参加の扱い**
   - 自動で「応援」にする？
   - 次の曲まで待機？
